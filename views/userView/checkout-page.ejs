<%- include("../partials/userHeader") %>
<main>
  <!-- breadcrumb-area-start -->
  <section
    class="breadcrumb-area"
    data-background="/user-assets/img/bg/page-title.png"
  >
    <div class="container">
      <div class="row">
        <div class="col-xl-12">
          <div class="breadcrumb-text text-center">
            <h1>Checkout</h1>
            <ul class="breadcrumb-menu">
              <li><a href="/">home</a></li>
              <li><span>Checkout</span></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </section>
  <!-- breadcrumb-area-end -->

  <!-- checkout-area start -->
  <section class="checkout-area pb-70">
    <div class="container">
      <form action="/place-order" method="post">
        <div class="row">
          <div class="col-lg-6">
            <div class="checkbox-form">
              <h3>Billing Details</h3>
              <div class="row">
                <% allAddress.forEach(address => { %>
                <div class="col-md-4">
                  <!-- Adjust column size as needed -->
                  <div class="address-container">
                    <div class="checkout-form-list">
                      <label>First Name<span class="required">*</span></label>
                      <input
                        type="text"
                        name="firstName"
                        value="<%= address.firstName %>"
                        disabled
                      />
                    </div>
                    <div class="checkout-form-list">
                      <label>Last Name<span class="required">*</span></label>
                      <input
                        type="text"
                        name="lastName"
                        value="<%= address.lastName %>"
                        disabled
                      />
                    </div>
                    <div class="checkout-form-list">
                      <label>House / Flat<span class="required">*</span></label>
                      <input
                        type="text"
                        name="house"
                        value="<%= address.house %>"
                        disabled
                      />
                    </div>
                    <div class="checkout-form-list">
                      <label>Locality<span class="required">*</span></label>
                      <input
                        type="text"
                        name="locality"
                        value="<%= address.locality %>"
                        disabled
                      />
                    </div>
                    <div class="checkout-form-list">
                      <label>City<span class="required">*</span></label>
                      <input
                        type="text"
                        name="city"
                        value="<%= address.city %>"
                        disabled
                      />
                    </div>
                    <div class="checkout-form-list">
                      <label>State<span class="required">*</span></label>
                      <input
                        type="text"
                        name="state"
                        value="<%= address.state %>"
                        disabled
                      />
                    </div>
                    <div class="checkout-form-list">
                      <label>Pincode<span class="required">*</span></label>
                      <input
                        type="text"
                        name="pincode"
                        value="<%= address.pincode %>"
                        disabled
                      />
                    </div>
                    <div class="checkout-form-list">
                      <label
                        >Email Address<span class="required">*</span></label
                      >
                      <input
                        type="email"
                        name="email"
                        value="<%= address.email %>"
                        disabled
                      />
                    </div>
                    <div class="checkout-form-list">
                      <label>Phone<span class="required">*</span></label>
                      <input
                        type="text"
                        name="phone"
                        value="<%= address.phone %>"
                        disabled
                      />
                    </div>
                    <div class="select-address">
                      <input
                        type="checkbox"
                        id="selectAddress<%= address._id %>"
                        name="selectAddress"
                        value="<%= address._id %>"
                      />
                      <label for="selectAddress<%= address._id %>"
                        >Select This Address</label
                      >
                    </div>
                  </div>
                </div>
                <% }); %>
              </div>

              <div class="different-address">
                <div class="ship-different-title">
                  <h3>
             
                  </h3>
                </div>
                <div class="order-notes">
                  <div class="checkout-form-list">
              
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-6">
            <div class="your-order mb-30">
              <h3>Your order</h3>
              <div class="your-order-table table-responsive">
                <table>
                  <thead>
                    <tr>
                      <th class="product-name">Product</th>
                      <th class="product-size">Size</th>
                      <th class="product-total">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% for (let cartItem of cartItems) { %>
                    <tr class="cart_item">
                      <td class="product-name">
                        <%= cartItem.product.productName %> ×
                        <strong class="product-quantity"
                          ><%= cartItem.quantity %></strong
                        >
                      </td>
                      <td class="product-size"><%= cartItem.size %></td>
                      <td class="product-total">
                        ₹<%= cartItem.product.salePrice * cartItem.quantity %>
                      </td>
                    </tr>
                    <% } %>
                  </tbody>
                  <tfoot>
                    <tr class="shipping">
                      <th>Shipping Charge</th>
                      <td colspan="2">
                        <ul>
                          <li><label>₹70</label></li>
                        </ul>
                      </td>
                    </tr>
                    <tr class="order-total">
                      <th>Order Total</th>
                      <td></td>
                      <td>
                        <strong
                          ><span class="amount"
                            >₹<%= totalAmount+70 %></span
                          ></strong
                        >
                      </td>
                    </tr>
                  </tfoot>
                </table>
              </div>

              <div class="payment-method">
                <div class="accordion" id="accordionExample">
                  <div class="card">
                    <div class="card-header" id="headingOne">
                      <h5 class="mb-0">
                        <input
                          type="checkbox"
                          id="cod-checkbox"
                          class="styled-checkbox"
                          name="payment_method"
                          value="Cash on Delivery"
                        />
                        <label for="cod-checkbox" class="checkbox-label"
                          >Cash on Delivery (COD)</label
                        >
                      </h5>
                    </div>

                    <div
                      id="collapseOne"
                      class="collapse show"
                      aria-labelledby="headingOne"
                      data-parent="#accordionExample"
                    >
                      <div class="card-body">
                        Pay with cash upon delivery of your order.
                      </div>
                    </div>
                  </div>
                </div>
                <div class="accordion" id="accordionExample">
                  <div class="card">
                    <div class="card-header" id="headingOne">
                      <h5 class="mb-0">
                        <input
                          type="checkbox"
                          id="cod-checkbox"
                          class="styled-checkbox"
                          name="payment_method"
                          value="wallet"
                        />
                        <label for="cod-checkbox" class="checkbox-label"
                          >Wallet</label
                        >
                      </h5>
                    </div>

                    <div
                      id="collapseOne"
                      class="collapse show"
                      aria-labelledby="headingOne"
                      data-parent="#accordionExample"
                    >
                      <div class="card-body">
                        Pay with cash using wallet money.
                      </div>
                    </div>
                  </div>
                </div>
                <div class="order-button-payment mt-20">
                  <button type="submit" class="btn theme-btn">
                    Place order
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </section>
  <!-- checkout-area end -->
</main>

<%- include("../partials/userFooter") %>

<script>
    // Wait for the document to be fully loaded
    document.addEventListener("DOMContentLoaded", function() {
        // Get all the checkboxes for selecting addresses
        var checkboxes = document.querySelectorAll('input[name="selectAddress"]');
        
        // Add a click event listener to each checkbox
        checkboxes.forEach(function(checkbox) {
            checkbox.addEventListener('click', function(event) {
                // Check if the checkbox is checked
                if (this.checked) {
                    // If checked, do something (e.g., highlight the selected address)
                    var selectedAddressId = this.value; // Get the ID of the selected address
                    var selectedAddressContainer = document.querySelector('#address_' + selectedAddressId); // Get the container of the selected address
                    // Example: Add a class to highlight the selected address
                    selectedAddressContainer.classList.add('selected-address');
                    
                    // Optionally, you can also perform additional actions here, such as updating the UI to reflect the selected address
                } else {
                    // If unchecked, you can perform some other actions (e.g., remove the highlight)
                    var selectedAddressId = this.value; // Get the ID of the selected address
                    var selectedAddressContainer = document.querySelector('#address_' + selectedAddressId); // Get the container of the selected address
                    // Example: Remove the class to unhighlight the selected address
                    selectedAddressContainer.classList.remove('selected-address');
                }
            });
        });
    });
</script>


<script>
  // Function to fetch all countries from the REST Countries API
  async function fetchCountries() {
    try {
      const response = await fetch("https://restcountries.com/v3.1/all");
      const data = await response.json();
      return data;
    } catch (error) {
      console.error("Error fetching countries:", error);
      return [];
    }
  }

  // Function to populate the select dropdown with country options
  async function populateCountries() {
    const selectCountry = document.querySelector('select[name="country"]');
    const selectState = document.querySelector('input[name="state"]');

    // Fetch all countries
    const countries = await fetchCountries();

    // Sort countries alphabetically by name
    countries.sort((a, b) => {
      if (a.name.common < b.name.common) return -1;
      if (a.name.common > b.name.common) return 1;
      return 0;
    });

    // Clear existing options
    selectCountry.innerHTML = "";

    // Populate the select dropdown with countries
    countries.forEach((country) => {
      const option = document.createElement("option");
      option.value = country.name.common;
      option.textContent = country.name.common;
      selectCountry.appendChild(option);
    });

    // Auto-locate the user's location
    autoLocateLocation(selectCountry, selectState);
  }

  // Function to auto-locate the user's location
  function autoLocateLocation(selectCountry, selectState) {
    // Check if geolocation is supported by the browser
    if ("geolocation" in navigator) {
      // Get user's current position
      navigator.geolocation.getCurrentPosition(async (position) => {
        const { latitude, longitude } = position.coords;
        const location = await reverseGeocode(latitude, longitude);
        if (location) {
          const { city, state, country } = location;
          // Select the detected location in the dropdowns
          selectCountry.value = country;
          selectState.value = state;
        }
      });
    } else {
      console.error("Geolocation is not supported by this browser.");
    }
  }

  // Function to reverse geocode the location from coordinates
  async function reverseGeocode(latitude, longitude) {
    try {
      const response = await fetch(
        `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=en`
      );
      const data = await response.json();
      return {
        state: data.principalSubdivision,
        country: data.countryName,
      };
    } catch (error) {
      console.error("Error reverse geocoding:", error);
      return null;
    }
  }

  // Call the populateCountries function when the DOM is loaded
  document.addEventListener("DOMContentLoaded", populateCountries);
</script>

<script>
  // JavaScript to toggle CSS class on COD button click
  document.addEventListener("DOMContentLoaded", function () {
    const codButton = document.querySelector(".cod-button");
    codButton.addEventListener("click", function () {
      codButton.classList.toggle("clicked");
    });
  });
</script>

<script>
  // Get the checkbox element
  const codCheckbox = document.getElementById("cod-checkbox");

  // Check if the checkbox is checked
  if (codCheckbox.checked) {
    console.log("Cash on Delivery (COD) option is checked");
  } else {
    console.log("Cash on Delivery (COD) option is not checked");
  }
</script>

<style>
  table {
    border-collapse: separate;
    border-spacing: 10px; /* Adjust the spacing as needed */
    width: 100%;
    border: 1px solid #ccc; /* Outside border color */
  }

  th,
  td {
    padding: 10px; /* Adjust padding as needed */
    border-bottom: 1px solid #ddd; /* Bottom border color */
  }

  th {
    background-color: #f2f2f2; /* Grey shaded background color for header */
  }

  tbody tr:last-child td {
    border-bottom: none; /* Remove bottom border from last row */
  }
</style>
