<%- include("../partials/adminHeader") %>

<div class="content-header">
  <div>
    <h2 class="content-title card-title">Stock</h2>
  </div>
</div>

<div class="right mt-5">
  <table class="table table-striped">
    <thead>
      <tr>
        <th scope="col"><b>Product name</b></th>
        <th scope="col"><b>Small</b></th>
        <th scope="col"><b>Medium</b></th>
        <th scope="col"><b>Large</b></th>
        <th scope="col"><b>Total</b></th>
        <th scope="col"><b>Action</b></th>
      </tr>
    </thead>
    <tbody id="productList">
      <!-- Product details will be dynamically inserted here -->
    </tbody>
  </table>
  <div class="pagination">
    <!-- Pagination buttons will be dynamically inserted here -->
  </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
  function fetchProducts(page = 1) {
    $.ajax({
      url: '/admin/stockPage',
      type: 'GET',
      data: { page: page },
      success: function(response) {
        const { data, currentPage, totalPages } = response;

        const tbody = $("#productList");
        tbody.empty();

        data.forEach((product, index) => {
          let smallQty = 0, mediumQty = 0, largeQty = 0;
          product.productSizes.forEach((size) => {
            if (size.size === 'Small') {
              smallQty = size.quantity;
            } else if (size.size === 'Medium') {
              mediumQty = size.quantity;
            } else if (size.size === 'Large') {
              largeQty = size.quantity;
            }
          });

          const productRow = `
            <tr>
              <td>${product.productName}</td>
              <td>
                <form class="update-form">
                  <input type="hidden" name="productId" value="${product._id}">
                  <input type="number" name="smallQty" value="${smallQty}" required>
              </td>
              <td>
                <input type="number" name="mediumQty" value="${mediumQty}" required>
              </td>
              <td>
                <input type="number" name="largeQty" value="${largeQty}" required>
              </td>
              <td>${product.totalQuantity}</td>
              <td>
                <button type="submit" style="background-color: rgb(112, 112, 255); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Update</button>
                </form>
              </td>
            </tr>`;
          tbody.append(productRow);
        });

        const pagination = $(".pagination");
        pagination.empty();
        for (let i = 1; i <= totalPages; i++) {
          const pageButton = `<a href="#" class="btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</a>`;
          pagination.append(pageButton);
        }

        $(".pagination .btn").click(function(e) {
          e.preventDefault();
          const page = $(this).data("page");
          fetchProducts(page);
        });

        $(".update-form").submit(function(e) {
          e.preventDefault();
          const form = $(this);
          $.ajax({
            url: '/admin/updateStock',
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
              alert(response.message);
              fetchProducts(currentPage);
            },
            error: function(xhr, status, error) {
              console.error("Failed to update stock:", error);
            }
          });
        });
      },
      error: function(xhr, status, error) {
        console.error("Failed to fetch products:", error);
      }
    });
  }

  $(document).ready(function() {
    fetchProducts();
  });
</script>

<%- include("../partials/adminFooter") %>
